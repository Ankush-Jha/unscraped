<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace - ReLoop</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../../css/styles.css">

    <style>
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            z-index: var(--z-nav);
            border-bottom: 1px solid var(--color-border);
        }

        .page-title {
            font-size: var(--text-2xl);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.02em;
        }

        .main-content {
            padding: var(--space-4);
            padding-bottom: 140px;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            margin-bottom: var(--space-4);
        }

        .search-bar .icon {
            color: var(--color-text-muted);
            font-size: 20px;
        }

        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--color-text-primary);
            font-family: var(--font-display);
            font-size: var(--text-base);
        }

        .search-bar input::placeholder {
            color: var(--color-text-muted);
        }

        .search-bar input:focus {
            outline: none;
        }

        /* Category Pills */
        .category-section {
            margin-bottom: var(--space-6);
            overflow-x: auto;
        }

        .category-row {
            display: flex;
            gap: var(--space-2);
            padding-bottom: var(--space-2);
        }

        .category-pill {
            flex-shrink: 0;
            padding: var(--space-2) var(--space-4);
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-family: var(--font-display);
            font-size: var(--text-sm);
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-base);
            white-space: nowrap;
        }

        .category-pill:hover {
            border-color: var(--color-text-primary);
        }

        .category-pill.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
        }

        /* Last Chance Deals */
        .deals-section {
            margin-bottom: var(--space-6);
        }

        .deals-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .deals-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-lg);
            font-weight: 900;
            text-transform: uppercase;
        }

        .deals-title .icon {
            color: var(--color-warning);
        }

        .deals-row {
            display: flex;
            gap: var(--space-3);
            overflow-x: auto;
            padding-bottom: var(--space-2);
            scrollbar-width: none;
        }

        .deals-row::-webkit-scrollbar {
            display: none;
        }

        .deal-card {
            flex-shrink: 0;
            width: 140px;
            background: var(--color-surface-card);
            border: 2px solid var(--color-warning);
            border-radius: var(--radius-xl);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            color: inherit;
        }

        .deal-card:hover {
            transform: scale(1.02);
        }

        .deal-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: var(--color-surface-dark);
        }

        .deal-content {
            padding: var(--space-3);
        }

        .deal-timer {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
            font-weight: 700;
            color: var(--color-warning);
            margin-bottom: var(--space-1);
        }

        .deal-timer .icon {
            font-size: 14px;
        }

        .deal-title {
            font-size: var(--text-sm);
            font-weight: 700;
            margin-bottom: var(--space-1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .deal-price {
            font-size: var(--text-base);
            font-weight: 900;
            color: var(--color-primary);
        }

        /* Product Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }

        .product-card {
            background: var(--color-surface-dark);
            border: 2px solid transparent;
            border-radius: var(--radius-xl);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            color: inherit;
        }

        .product-card:hover {
            border-color: var(--color-primary);
        }

        .product-image-container {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            background: var(--color-surface-card);
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-slow);
        }

        .product-card:hover .product-image {
            transform: scale(1.1);
        }

        .product-badge {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .product-badge .icon {
            font-size: 12px;
        }

        .product-content {
            padding: var(--space-3);
        }

        .product-title {
            font-size: var(--text-base);
            font-weight: 700;
            margin-bottom: var(--space-1);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .product-price {
            font-size: var(--text-lg);
            font-weight: 900;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .product-price .icon {
            font-size: 16px;
        }

        .product-distance {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .product-distance .icon {
            font-size: 12px;
        }

        /* ========================================
           Filter Modal
           ======================================== */
        .filter-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            align-items: flex-end;
        }

        .filter-modal.active {
            display: flex;
        }

        .filter-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .filter-panel {
            position: relative;
            width: 100%;
            max-height: 80vh;
            background: var(--color-surface-dark);
            border-top-left-radius: var(--radius-2xl);
            border-top-right-radius: var(--radius-2xl);
            padding: var(--space-4);
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .filter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-5);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .filter-title {
            font-size: var(--text-xl);
            font-weight: 900;
            text-transform: uppercase;
        }

        .filter-close {
            width: 36px;
            height: 36px;
            background: var(--color-surface-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-text-primary);
            transition: all var(--transition-base);
        }

        .filter-close:hover {
            background: var(--color-error);
            border-color: var(--color-error);
        }

        .filter-section {
            margin-bottom: var(--space-5);
        }

        .filter-section-title {
            font-size: var(--text-sm);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-text-muted);
            margin-bottom: var(--space-3);
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .filter-option {
            padding: var(--space-2) var(--space-4);
            background: var(--color-surface-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .filter-option:hover {
            border-color: var(--color-text-primary);
        }

        .filter-option.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
        }

        .filter-range {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .filter-range input[type="range"] {
            flex: 1;
            height: 4px;
            background: var(--color-surface-card);
            border-radius: var(--radius-full);
            appearance: none;
        }

        .filter-range input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .filter-range-value {
            font-family: monospace;
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--color-primary);
            min-width: 60px;
            text-align: right;
        }

        .filter-apply-btn {
            width: 100%;
            padding: var(--space-4);
            background: var(--color-primary);
            border: none;
            border-radius: var(--radius-xl);
            font-size: var(--text-lg);
            font-weight: 900;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .filter-apply-btn:hover {
            filter: brightness(1.1);
        }

        /* Enhanced Deal Cards with Days Left */
        .deal-badge {
            position: absolute;
            top: var(--space-2);
            left: var(--space-2);
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--color-error);
            border-radius: var(--radius-md);
            font-size: 10px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            animation: urgencyPulse 2s ease-in-out infinite;
        }

        @keyframes urgencyPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5);
            }

            50% {
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }
        }

        .deal-badge .icon {
            font-size: 12px;
        }

        .deal-image-container {
            position: relative;
        }

        .deal-discount {
            position: absolute;
            bottom: var(--space-2);
            right: var(--space-2);
            padding: 4px 8px;
            background: var(--color-primary);
            border-radius: var(--radius-md);
            font-size: 10px;
            font-weight: 800;
            color: #000;
        }

        .deal-original-price {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-decoration: line-through;
            margin-left: var(--space-1);
        }

        /* Product Urgency Badges */
        .product-urgency {
            position: absolute;
            top: var(--space-2);
            left: var(--space-2);
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.9);
            backdrop-filter: blur(4px);
            border-radius: var(--radius-md);
            font-size: 9px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
        }

        .product-urgency.warning {
            background: rgba(245, 158, 11, 0.9);
        }

        .product-urgency .icon {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="page-header">
            <h1 class="page-title">Marketplace</h1>
            <div style="display: flex; gap: var(--space-2);">
                <button class="icon-btn" onclick="openFilterModal()">
                    <span class="material-symbols-outlined">filter_list</span>
                </button>
                <a href="../user/notifications.html" class="icon-btn">
                    <span class="material-symbols-outlined">notifications</span>
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Search Bar -->
            <div class="search-bar fade-in">
                <span class="material-symbols-outlined icon">search</span>
                <input type="text" placeholder="Search items near you...">
            </div>

            <!-- Categories -->
            <div class="category-section">
                <div class="category-row">
                    <button class="category-pill active">All</button>
                    <button class="category-pill">Furniture</button>
                    <button class="category-pill">Books</button>
                    <button class="category-pill">Electronics</button>
                    <button class="category-pill">Clothes</button>
                    <button class="category-pill">Kitchen</button>
                    <button class="category-pill">Sports</button>
                </div>
            </div>

            <!-- Last Chance Deals -->
            <section class="deals-section">
                <div class="deals-header">
                    <span class="deals-title">
                        <span class="material-symbols-outlined icon">local_fire_department</span>
                        Last Chance Deals
                    </span>
                </div>
                <div class="deals-row" id="deals-grid">
                    <!-- Dynamic Deals will be loaded here -->
                    <div style="width:100%; text-align:center; padding:20px; color:var(--color-text-muted);">Loading
                        deals...</div>
                </div>
            </section>

            <!-- Products Grid -->
            <section class="products-section">
                <div class="section-header">
                    <h2 class="section-title">Near You</h2>
                    <a href="../core/search.html" class="section-link">See All</a>
                </div>

                <div class="products-grid" id="public-listings-grid">
                    <!-- Listings loaded dynamically -->
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px 0;">
                        <span class="material-symbols-outlined icon spin"
                            style="font-size: 32px; color: var(--color-text-muted);">progress_activity</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="../core/home.html" class="nav-link">
                        <span class="material-symbols-outlined icon">home</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="../core/search.html" class="nav-link active">
                        <span class="material-symbols-outlined icon icon-filled">search</span>
                    </a>
                </li>
                <li class="nav-item nav-add-btn">
                    <a href="../scanner/result.html" class="icon-btn">
                        <span class="material-symbols-outlined icon">add</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="../user/messages.html" class="nav-link">
                        <span class="material-symbols-outlined icon">chat_bubble</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="../user/profile.html" class="nav-link">
                        <span class="material-symbols-outlined icon">person</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Noise Overlay -->
    <div class="noise-overlay"></div>

    <!-- Filter Modal -->
    <div class="filter-modal" id="filter-modal">
        <div class="filter-overlay" onclick="closeFilterModal()"></div>
        <div class="filter-panel">
            <div class="filter-header">
                <h2 class="filter-title">Filters</h2>
                <button class="filter-close" onclick="closeFilterModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="filter-section">
                <h3 class="filter-section-title">Category</h3>
                <div class="filter-options">
                    <button class="filter-option active">All</button>
                    <button class="filter-option">Furniture</button>
                    <button class="filter-option">Books</button>
                    <button class="filter-option">Electronics</button>
                    <button class="filter-option">Clothes</button>
                    <button class="filter-option">Kitchen</button>
                    <button class="filter-option">Sports</button>
                    <button class="filter-option">Decor</button>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-section-title">Price Range (Coins)</h3>
                <div class="filter-range">
                    <input type="range" min="0" max="500" value="250" id="price-range">
                    <span class="filter-range-value" id="price-value">250</span>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-section-title">Sort By</h3>
                <div class="filter-options">
                    <button class="filter-option active">Newest</button>
                    <button class="filter-option">Price: Low</button>
                    <button class="filter-option">Price: High</button>
                    <button class="filter-option">Nearest</button>
                    <button class="filter-option">Popular</button>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-section-title">Condition</h3>
                <div class="filter-options">
                    <button class="filter-option active">All</button>
                    <button class="filter-option">New</button>
                    <button class="filter-option">Like New</button>
                    <button class="filter-option">Good</button>
                    <button class="filter-option">Fair</button>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-section-title">Special</h3>
                <div class="filter-options">
                    <button class="filter-option">ðŸ”¥ On Sale</button>
                    <button class="filter-option">âš¡ Ending Soon</button>
                    <button class="filter-option">âœ“ Verified Sellers</button>
                    <button class="filter-option">ðŸ†“ Free Items</button>
                </div>
            </div>

            <button class="filter-apply-btn" onclick="applyFilters()">Apply Filters</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../../js/firebase-config.js"></script>
    <script src="../../js/services/database.js"></script>
    <script src="../../js/app.js"></script>

    <script>
        // State
        let allListings = [];
        let currentCategory = 'All';
        let searchQuery = '';

        // Load listings on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                loadListings(),
                loadDeals()
            ]);
        });

        // MOCK DATA FOR DEMO
        const MOCK_LISTINGS = [
            {
                id: 'item-1',
                title: 'Ceramic Vase (Hand-painted)',
                category: 'Furniture',
                price: 150,
                condition: 'Like New',
                images: ['../../images/ceramic-vase.png'],
                seller: { id: 'demo-ankush', name: 'Ankush Jha', campus: 'ReLoop Campus' },
                description: 'Beautiful ceramic vase, perfect for flowers or shelf decor.'
            },
            {
                id: 'item-2',
                title: 'Minimalist Desk Lamp',
                category: 'Furniture',
                price: 85,
                condition: 'Good',
                images: ['../../images/desk-lamp.png'],
                seller: { id: 'user-2', name: 'Unnati Asthana', campus: 'East Wing' },
                description: 'Warm light lamp, great for studying.'
            },
            {
                id: 'item-3',
                title: 'Data Structures & Algorithms',
                category: 'Books',
                price: 45,
                condition: 'Used',
                images: ['../../images/study-books.png'],
                seller: { id: 'demo-ankush', name: 'Ankush Jha', campus: 'ReLoop Campus' },
                description: 'The definitive guide. Some highlighting inside.'
            },
            {
                id: 'item-4',
                title: 'Noise Cancelling Headphones',
                category: 'Electronics',
                price: 220,
                condition: 'Fair',
                images: ['../../images/headphones.png'],
                seller: { id: 'user-3', name: 'Uransh', campus: 'North Quad' },
                description: 'Great sound, slightly worn pads.'
            },
            {
                id: 'item-5',
                title: 'Stainless Electric Kettle',
                category: 'Kitchen',
                price: 60,
                condition: 'New',
                images: ['../../images/electric-kettle.png'],
                seller: { id: 'user-4', name: 'Rudrakh Bairagi', campus: 'West Block' },
                description: 'Brand new, never used. 1.5L capacity.'
            },
            {
                id: 'item-6',
                title: 'High-speed USB-C Charger',
                category: 'Electronics',
                price: 25,
                condition: 'Like New',
                images: ['../../images/phone-charger.png'],
                seller: { id: 'user-5', name: 'Mikey Trades', campus: 'ReLoop Campus' },
                description: 'Fast charging for all your devices.'
            }
        ];

        // Load listings (Hardcoded for demo)
        async function loadListings() {
            console.log('Forcing Mock Listings...');
            allListings = MOCK_LISTINGS;
            renderListings();
        }

        // Render listings to the grid
        function renderListings() {
            // FORCE CURRENT USER ID AS ANKUSH FOR DEMO
            const currentUserId = 'demo-ankush';

            // Filter by category and search
            let filtered = allListings;

            if (currentCategory !== 'All') {
                filtered = filtered.filter(l =>
                    l.category && l.category.toLowerCase() === currentCategory.toLowerCase()
                );
            }

            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(l =>
                    l.title.toLowerCase().includes(query) ||
                    (l.description && l.description.toLowerCase().includes(query))
                );
            }

            // Split into My Listings and Other Listings
            const myListings = filtered.filter(l => l.seller && l.seller.id === currentUserId);
            const otherListings = filtered.filter(l => !l.seller || l.seller.id !== currentUserId);

            // 1. Render Public Listings (Near You)
            const publicGrid = document.getElementById('public-listings-grid');
            if (publicGrid) {
                if (otherListings.length === 0) {
                    publicGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-text-muted);">
                            <span class="material-symbols-outlined" style="font-size: 48px; display: block; margin-bottom: 16px;">inventory_2</span>
                            No items found near you.
                        </div>
                    `;
                } else {
                    publicGrid.innerHTML = otherListings.map(listing => createListingCard(listing)).join('');
                }
            }

            // 2. Render My Listings (Your Marketplace)
            let dynamicSection = document.getElementById('dynamic-listings');

            if (myListings.length > 0) {
                if (!dynamicSection) {
                    const publicSection = document.querySelector('.products-section');
                    dynamicSection = document.createElement('section');
                    dynamicSection.id = 'dynamic-listings';
                    dynamicSection.className = 'products-section';
                    dynamicSection.style.marginBottom = 'var(--space-6)';
                    dynamicSection.innerHTML = `
                        <div class="section-header">
                            <h2 class="section-title">
                                <span class="material-symbols-outlined icon" style="color: var(--color-primary); vertical-align: middle;">storefront</span>
                                Your Marketplace
                            </h2>
                            <span class="section-link" id="my-listings-count">0 items</span>
                        </div>
                        <div class="products-grid" id="my-listings-grid"></div>
                    `;
                    publicSection.parentNode.insertBefore(dynamicSection, publicSection);
                }

                const myGrid = document.getElementById('my-listings-grid');
                const myCount = document.getElementById('my-listings-count');

                myCount.textContent = `${myListings.length} item${myListings.length === 1 ? '' : 's'}`;
                myGrid.innerHTML = myListings.map(listing => createListingCard(listing)).join('');

            } else if (dynamicSection) {
                dynamicSection.remove();
            }
        }

        // Load deals (Hardcoded for demo)
        async function loadDeals() {
            const container = document.getElementById('deals-grid');
            if (container) {
                // Take specific items for deals
                const dealItems = [MOCK_LISTINGS[4], MOCK_LISTINGS[1], MOCK_LISTINGS[2]];
                container.innerHTML = dealItems.map(listing => createDealCard(listing)).join('');
            }
        }

        // Helper to create card HTML
        function createListingCard(listing) {
            return `
                <a href="item.html?id=${listing.id}" class="product-card stagger-item fade-in">
                    <div class="product-image-container">
                        <img class="product-image" src="${listing.images?.[0] || '../../images/placeholder.png'}" alt="${listing.title}">
                        ${listing.condition === 'New' ? '<span class="product-badge" style="background: var(--color-primary); color: #000;">New</span>' : ''}
                        ${listing.seller?.campus ? `<span class="product-badge" style="bottom: 8px; top: auto; right: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 10px;">${listing.seller.campus}</span>` : ''}
                    </div>
                    <div class="product-content">
                        <h3 class="product-title">${listing.title}</h3>
                        <div class="product-meta">
                            <span class="product-price">
                                <span class="material-symbols-outlined icon icon-filled">eco</span>
                                ${listing.price}
                            </span>
                            <span class="product-distance">
                                <span class="material-symbols-outlined icon">sell</span>
                                ${listing.condition || 'Good'}
                            </span>
                        </div>
                    </div>
                </a>
            `;
        }

        function createDealCard(listing) {
            // Mock discount logic for visual flair
            const discount = Math.floor(Math.random() * 30) + 10;
            const originalPrice = Math.floor(listing.price * (1 + discount / 100));

            return `
                <a href="item.html?id=${listing.id}" class="deal-card stagger-item">
                    <div class="deal-image-container">
                        <img class="deal-image" src="${listing.images?.[0] || '../../images/placeholder.png'}" alt="${listing.title}">
                        <span class="deal-badge">
                            <span class="material-symbols-outlined icon">schedule</span>
                            ${Math.floor(Math.random() * 3) + 1} days left
                        </span>
                        <span class="deal-discount">-${discount}%</span>
                    </div>
                    <div class="deal-content">
                        <div class="deal-title">${listing.title}</div>
                        <div class="deal-price">${listing.price} coins <span class="deal-original-price">${originalPrice}</span></div>
                    </div>
                </a>
            `;
        }

        // Search functionality
        const searchInput = document.querySelector('.search-bar input');
        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value;
            renderListings();
        });

        // Category filtering
        document.querySelectorAll('.category-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                currentCategory = pill.textContent.trim();
                renderListings();
            });
        });

        // Filter modal functions
        function openFilterModal() {
            document.getElementById('filter-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFilterModal() {
            document.getElementById('filter-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function applyFilters() {
            showToast('Filters applied!', 'success');
            closeFilterModal();
            renderListings();
        }

        // Price range update
        document.getElementById('price-range')?.addEventListener('input', (e) => {
            document.getElementById('price-value').textContent = e.target.value;
        });

        // Toggle filter options
        document.querySelectorAll('.filter-option').forEach(btn => {
            btn.addEventListener('click', () => {
                const parent = btn.parentElement;
                const options = parent.querySelectorAll('.filter-option');
                if (parent.closest('.filter-section').querySelector('.filter-section-title').textContent.includes('Sort')) {
                    options.forEach(o => o.classList.remove('active'));
                    btn.classList.add('active');
                } else {
                    btn.classList.toggle('active');
                }
            });
        });
    </script>
</body>

</html>